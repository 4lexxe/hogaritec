<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Imagen</th>
            <th>Código</th>
            <th>Nombre</th>
            <th class="d-none d-md-table-cell">Categoría</th>
            <th>Precio</th>
            <th class="d-none d-md-table-cell">Stock</th>
            <th class="d-none d-lg-table-cell">Proveedor</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
          <tr>
            <td>
              {% if product.images.all|length > 0 %}
                <img src="{{ product.images.all.0.image.url }}" alt="{{ product.name }}" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;">
              {% else %}
                <img src="https://via.placeholder.com/60" alt="Sin imagen" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;">
              {% endif %}
            </td>
            <td>{{ product.code }}</td>
            <td>
              {{ product.name }}
              <div class="d-md-none">
                <small class="text-muted">{{ product.category }}</small>
              </div>
            </td>
            <td class="d-none d-md-table-cell">{{ product.category }}</td>
            <td>${{ product.price }}</td>
            <td class="d-none d-md-table-cell">{{ product.number }}</td>
            <td class="d-none d-lg-table-cell">
              {% if product.supplier %}
                {{ product.supplier.name }}
              {% else %}
                Sin proveedor
              {% endif %}
            </td>
            <td>
              <div class="btn-group" role="group">
                <a href="{% url 'edit_product' %}?id={{ product.id }}"
                   class="btn btn-sm btn-outline-primary" 
                   title="Editar">
                  <i class="bi bi-pencil"></i>
                  <span class="d-none d-md-inline">Editar</span>
                </a>
                <button class="btn btn-sm btn-outline-danger delete-product" 
                        title="Eliminar" 
                        data-bs-toggle="modal" 
                        data-bs-target="#deleteProductModal" 
                        data-product-id="{{ product.id }}"
                        data-product-name="{{ product.name }}">
                  <i class="bi bi-trash"></i>
                  <span class="d-none d-md-inline">Eliminar</span>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="mt-3 text-center">
      <a href="{% url 'products_dashboard_view' %}" class="btn btn-primary">Ver más productos</a>
    </div>
  </div>
</div>

<!-- Modal de confirmación para eliminar producto -->
<div class="modal fade" id="deleteProductModal" tabindex="-1" aria-labelledby="deleteProductModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteProductModalLabel">Confirmar eliminación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ¿Estás seguro de que deseas eliminar el producto <span id="productNameToDelete"></span>?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteProduct">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<style>
  @media (max-width: 767px) {
    .table-responsive {
      border: 0;
    }
    .table-responsive table {
      border: 0;
    }
    .table-responsive table thead {
      display: none;
    }
    .table-responsive table tr {
      margin-bottom: 10px;
      display: block;
      border-bottom: 2px solid #ddd;
    }
    .table-responsive table td {
      display: block;
      text-align: right;
      padding-left: 50%;
      position: relative;
    }
    .table-responsive table td:before {
      content: attr(data-label);
      position: absolute;
      left: 6px;
      width: 45%;
      padding-right: 10px;
      white-space: nowrap;
      text-align: left;
      font-weight: bold;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const deleteProductModal = document.getElementById('deleteProductModal');
    const productNameToDelete = document.getElementById('productNameToDelete');
    const confirmDeleteButton = document.getElementById('confirmDeleteProduct');
    let productIdToDelete;

    deleteProductModal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      productIdToDelete = button.getAttribute('data-product-id');
      const productName = button.getAttribute('data-product-name');
      productNameToDelete.textContent = productName;
    });

    confirmDeleteButton.addEventListener('click', function() {
      fetch('{% url "delete_product" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `product_id=${productIdToDelete}`
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Eliminar la fila del producto de la tabla
          const productRow = document.querySelector(`[data-product-id="${productIdToDelete}"]`).closest('tr');
          productRow.remove();
          
          // Redirigir al dashboard y mostrar el mensaje de éxito
          window.location.href = data.redirect_url + '?message=' + encodeURIComponent(data.message);
        } else {
          alert('Error al eliminar el producto: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al eliminar el producto');
      });
    });

    // Add data-label attributes to table cells for mobile view
    const table = document.querySelector('.table');
    const headers = table.querySelectorAll('th');
    const rows = table.querySelectorAll('tbody tr');

    rows.forEach(row => {
      const cells = row.querySelectorAll('td');
      cells.forEach((cell, index) => {
        if (headers[index]) {
          cell.setAttribute('data-label', headers[index].textContent);
        }
      });
    });
  });
</script>